#!/bin/bash
  
#
# Dovecot Autodiscovery - Sieve IMAPSieve
# =======================================
# 
# This script autogenerates the sieve imapsieve configuration for a dovecot server.

set -e
umask 0022

myhostname=$(cat /etc/hostname)

logger -t "${0}" "Notice: Creating dovecot 90-sieve-imapsieve.conf..."

if [ ! -e "/var/spool/dovecot/sieve/report-ham.sieve" ]; then
  touch /var/spool/dovecot/sieve/report-ham.sieve
  /usr/bin/sievec /var/spool/dovecot/sieve/report-ham.sieve
fi

if [ ! -e "/var/spool/dovecot/sieve/report-spam.sieve" ]; then
  touch /var/spool/dovecot/sieve/report-spam.sieve
  /usr/bin/sievec /var/spool/dovecot/sieve/report-spam.sieve
fi

cat > "90-sieve-imapsieve.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

plugin {

  # From elsewhere to Junk folder
  imapsieve_mailbox1_name = Junk
  imapsieve_mailbox1_causes = COPY
  imapsieve_mailbox1_before = file:/var/spool/dovecot/sieve/report-spam.sieve

  # From Junk folder to elsewhere
  imapsieve_mailbox2_name = *
  imapsieve_mailbox2_from = Junk
  imapsieve_mailbox2_causes = COPY
  imapsieve_mailbox2_before = file:/var/spool/dovecot/sieve/report-ham.sieve

}

EOF

install -m 644 "90-sieve-imapsieve.conf" "/etc/dovecot/conf.d/90-sieve-imapsieve.conf"


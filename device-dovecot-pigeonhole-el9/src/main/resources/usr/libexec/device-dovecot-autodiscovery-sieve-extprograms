#!/bin/bash
  
#
# Dovecot Autodiscovery - Sieve Extprograms
# =========================================
# 
# This script autogenerates the sieve external programs configuration for a dovecot server.

set -e
umask 0022

myhostname=$(cat /etc/hostname)

logger -t "${0}" "Notice: Creating dovecot 90-sieve-extprograms.conf..."

cat > "90-sieve-extprograms.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

# Sieve Extprograms plugin configuration

# Don't forget to add the sieve_extprograms plugin to the sieve_plugins setting.
# Also enable the extensions you need (one or more of vnd.dovecot.pipe,
# vnd.dovecot.filter and vnd.dovecot.execute) by adding these	to the
# sieve_extensions or sieve_global_extensions settings. Restricting these
# extensions to a global context using sieve_global_extensions is recommended.

plugin {

  # The directory where the program sockets are located for the
  # vnd.dovecot.pipe, vnd.dovecot.filter and vnd.dovecot.execute extension
  # respectively. The name of each unix socket contained in that directory
  # directly maps to a program-name referenced from the Sieve script.
  sieve_pipe_socket_dir = sieve-pipe
  sieve_filter_socket_dir = sieve-filter
  sieve_execute_socket_dir = sieve-execute

  # The directory where the scripts are located for direct execution by the
  # vnd.dovecot.pipe, vnd.dovecot.filter and vnd.dovecot.execute extension
  # respectively. The name of each script contained in that directory
  # directly maps to a program-name referenced from the Sieve script.
  sieve_pipe_bin_dir = /var/lib/dovecot-sieve/sieve-pipe
  sieve_filter_bin_dir = /var/lib/dovecot-sieve/sieve-filter
  sieve_execute_bin_dir = /var/lib/dovecot-sieve/sieve-execute
}

# An example program service called 'do-something' to pipe messages to
#service do-something {
  # Define the executed script as parameter to the sieve service
  #executable = script /usr/lib/dovecot/sieve-pipe/do-something.sh

  # Use some unprivileged user for executing the program
  #user = dovenull

  # The unix socket located in the sieve_pipe_socket_dir (as defined in the 
  # plugin {} section above)
  #unix_listener sieve-pipe/do-something {
    # LDA/LMTP must have access
  #  user = vmail  
  #  mode = 0600
  #}
#}

EOF

install -m 640 "90-sieve-extprograms.conf" "/etc/dovecot/conf.d/90-sieve-extprograms.conf"


